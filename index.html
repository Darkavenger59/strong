<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B-Strong Tracker üí™</title>
    <style>
        :root {
            --primary: #FF5722; /* Couleur un peu dynamique */
            --bg: #f4f6f8;
            --card-bg: #ffffff;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg);
            color: #333;
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        h1 { text-align: center; color: var(--primary); }
        
        /* Styles des formulaires */
        .input-group { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
            flex-wrap: wrap;
        }
        input { 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            flex: 1; /* Prend la place dispo */
        }
        /* Le bouton ajouter */
        .btn-add {
            background-color: #333;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Liste en cours */
        ul { list-style: none; padding: 0; }
        li { 
            background: #fff; 
            padding: 10px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between;
        }

        /* Bouton Sauvegarder (Gros bouton vert) */
        #btnSave { 
            background-color: var(--primary); 
            color: white; 
            width: 100%; 
            padding: 15px; 
            border: none; 
            border-radius: 8px; 
            font-size: 1.1em; 
            cursor: pointer; 
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background 0.3s;
        }
        #btnSave:hover { background-color: #e64a19; }

        /* Historique */
        #history { margin-top: 40px; }
        .workout-card { 
            background: var(--card-bg); 
            margin: 15px 0; 
            padding: 15px; 
            border-radius: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .workout-date { color: #888; font-size: 0.9em; margin-bottom: 10px; display: block;}
        .workout-list li { border-bottom: 1px dashed #eee; }
    </style>
</head>
<body>

    <h1>üî• B-Strong Tracker</h1>

    <div class="input-group">
        <input type="text" id="exoName" placeholder="Exercice (ex: Squat)">
        <input type="number" id="exoReps" placeholder="Reps">
        <input type="number" id="exoWeight" placeholder="Poids (kg)">
    </div>
    <button class="btn-add" onclick="ajouterExercice()">+ Ajouter √† la s√©ance</button>

    <h3>S√©ance en cours :</h3>
    <ul id="currentSessionList">
        <li style="color:#888; font-style:italic;" id="emptyMsg">Aucun exercice ajout√©...</li>
    </ul>

    <button id="btnSave">
        üíæ Terminer et Sauvegarder
    </button>

    <div id="history">
        <h2>üìÖ Historique des s√©ances</h2>
        <div id="historyList">Chargement de l'historique...</div>
    </div>

    <script type="module">
        // 1. IMPORTS (Vers les CDN pour fonctionner sans installation)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. TA CONFIGURATION (B-Strong)
        const firebaseConfig = {
          apiKey: "AIzaSyBuzNrrB-rK_xcjSeGtFc3I9yUKHhRUcIY",
          authDomain: "b-strong-4c3d1.firebaseapp.com",
          projectId: "b-strong-4c3d1",
          storageBucket: "b-strong-4c3d1.firebasestorage.app",
          messagingSenderId: "746501272062",
          appId: "1:746501272062:web:b2181766fd23ce8a3f10af"
        };

        // 3. INITIALISATION
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); // Connexion √† la base de donn√©es

        console.log("Firebase B-Strong connect√© !");

        // 4. LOGIQUE LOCALE (Gestion du tableau temporaire)
        let sessionEnCours = []; 

        // On attache la fonction au scope global pour le bouton HTML
        window.ajouterExercice = function() {
            const nom = document.getElementById('exoName').value;
            const reps = document.getElementById('exoReps').value;
            const poids = document.getElementById('exoWeight').value;

            if(nom && reps) {
                // Masquer le message "vide"
                const emptyMsg = document.getElementById('emptyMsg');
                if(emptyMsg) emptyMsg.style.display = 'none';

                // Ajouter aux donn√©es
                sessionEnCours.push({ nom, reps, poids });

                // Ajouter visuellement
                const li = document.createElement('li');
                li.innerHTML = `<strong>${nom}</strong> <span>${reps} reps @ ${poids}kg</span>`;
                document.getElementById('currentSessionList').appendChild(li);

                // Vider les champs
                document.getElementById('exoName').value = '';
                document.getElementById('exoReps').value = '';
                document.getElementById('exoWeight').value = '';
                document.getElementById('exoName').focus(); // Remettre le curseur
            } else {
                alert("Il faut au moins un nom et un nombre de r√©p√©titions !");
            }
        }

        // 5. LOGIQUE DE SAUVEGARDE (Envoi vers Firestore)
        document.getElementById('btnSave').addEventListener('click', async () => {
            if (sessionEnCours.length === 0) {
                alert("Ajoute au moins un exercice avant de sauvegarder !");
                return;
            }

            const btn = document.getElementById('btnSave');
            const originalText = btn.textContent;
            btn.textContent = "Envoi en cours...";
            btn.disabled = true;

            try {
                // Envoi dans la collection "workouts" de ton projet b-strong
                await addDoc(collection(db, "workouts"), {
                    date: serverTimestamp(),
                    exercises: sessionEnCours
                });

                alert("‚úÖ S√©ance enregistr√©e avec succ√®s !");
                
                // Reset total
                sessionEnCours = [];
                document.getElementById('currentSessionList').innerHTML = '<li style="color:#888; font-style:italic;" id="emptyMsg">Aucun exercice ajout√©...</li>';
                
                // Rafraichir l'historique
                chargerHistorique();

            } catch (e) {
                console.error("Erreur : ", e);
                alert("Erreur lors de la sauvegarde : " + e.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });

        // 6. LOGIQUE DE LECTURE (R√©cup√©rer l'historique)
        async function chargerHistorique() {
            const container = document.getElementById('historyList');
            
            try {
                // Requ√™te pour r√©cup√©rer les s√©ances tri√©es par date
                const q = query(collection(db, "workouts"), orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);

                container.innerHTML = ""; // Vider le chargement

                if (querySnapshot.empty) {
                    container.innerHTML = "<p>Aucune s√©ance trouv√©e dans l'historique.</p>";
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Gestion de la date
                    let dateString = "Date inconnue";
                    if(data.date) {
                        // Convertir le timestamp Firebase en date JS
                        const dateObj = data.date.toDate();
                        dateString = dateObj.toLocaleDateString("fr-FR", { weekday: 'long', day: 'numeric', month: 'long' }) 
                                   + ' √† ' + dateObj.toLocaleTimeString("fr-FR", { hour: '2-digit', minute:'2-digit' });
                    }

                    // Construction de la carte HTML
                    const card = document.createElement('div');
                    card.className = 'workout-card';
                    
                    let exosHtml = "<ul class='workout-list'>";
                    if(data.exercises && Array.isArray(data.exercises)) {
                        data.exercises.forEach(ex => {
                            exosHtml += `<li>${ex.nom} : ${ex.reps} reps √† ${ex.poids}kg</li>`;
                        });
                    }
                    exosHtml += "</ul>";

                    card.innerHTML = `<span class="workout-date">üìÖ ${dateString}</span>${exosHtml}`;
                    container.appendChild(card);
                });
            } catch (e) {
                console.error("Erreur lecture : ", e);
                container.innerHTML = "Impossible de charger l'historique (v√©rifie ta connexion ou tes r√®gles Firestore).";
            }
        }

        // Lancer le chargement au d√©marrage
        chargerHistorique();

    </script>
</body>
</html>
