<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B-Strong App</title>
    <style>
        /* --- CHARTE GRAPHIQUE "STRONG" --- */
        :root {
            --bg-app: #000000;
            --bg-card: #1C1C1E;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --accent-blue: #0A84FF; /* Le bleu Strong */
            --accent-red: #FF453A;
            --accent-green: #30D158;
            --separator: #38383A;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-app);
            color: var(--text-primary);
            font-family: var(--font-stack);
            margin: 0;
            padding: 0;
            padding-bottom: 80px; /* Espace pour le bouton flottant */
        }

        /* --- HEADER --- */
        header {
            padding: 20px;
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--separator);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { margin: 0; font-size: 20px; font-weight: 700; letter-spacing: 0.5px; }
        .profile-icon { width: 32px; height: 32px; background: var(--separator); border-radius: 50%; }

        /* --- VUES (Système d'onglets simple) --- */
        .view { display: none; padding: 15px; }
        .view.active { display: block; }

        /* --- HISTORIQUE (STYLE STRONG) --- */
        .history-card {
            background-color: var(--bg-card);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--separator);
            padding-bottom: 10px;
        }
        .history-title { font-weight: 600; font-size: 16px; }
        .history-date { color: var(--text-secondary); font-size: 14px; }
        
        .set-preview {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-top: 5px;
            color: var(--text-secondary);
        }
        .set-preview strong { color: var(--text-primary); }

        /* --- SÉANCE EN COURS --- */
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            background: var(--bg-card);
            padding: 15px;
            border-radius: 10px;
        }
        .input-group { flex: 1; }
        .input-group label { display: block; color: var(--text-secondary); font-size: 12px; margin-bottom: 5px; text-transform: uppercase; }
        
        input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--separator);
            color: white;
            font-size: 18px;
            padding: 5px 0;
            border-radius: 0;
        }
        input:focus { outline: none; border-bottom-color: var(--accent-blue); }

        /* Bouton Ajouter Set */
        .btn-add-set {
            width: 100%;
            background-color: var(--bg-card);
            color: var(--accent-blue);
            border: 1px solid var(--accent-blue);
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 20px;
            cursor: pointer;
        }
        .btn-add-set:active { opacity: 0.7; }

        /* Liste des exos en cours */
        .current-exercise-list { list-style: none; padding: 0; }
        .current-exercise-item {
            background-color: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--accent-blue);
        }
        .exo-info { font-size: 16px; font-weight: 600; }
        .exo-details { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }

        /* --- BOUTONS FLOTTANTS / ACTIONS --- */
        .fab-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-primary {
            background-color: var(--accent-blue);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
            cursor: pointer;
            width: 100%;
        }
        
        .btn-danger {
            background-color: var(--accent-red); /* Rouge pour finir */
        }

        .btn-cancel {
            background-color: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 10px;
            width: 100%;
            cursor: pointer;
        }

        /* --- HELPER TEXT --- */
        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            margin-top: 50px;
        }
    </style>
</head>
<body>

    <header>
        <h1>B-STRONG</h1>
        <div class="profile-icon"></div>
    </header>

    <div id="viewHistory" class="view active">
        <h2 style="font-size: 14px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 10px;">Historique récent</h2>
        <div id="historyList">
            <div class="empty-state">Chargement...</div>
        </div>

        <div class="fab-container">
            <button class="btn-primary" onclick="switchView('workout')">Démarrer une séance vide</button>
        </div>
    </div>

    <div id="viewWorkout" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;">Séance en cours</h2>
            <span id="timer" style="font-variant-numeric: tabular-nums; color:var(--text-secondary);">00:00</span>
        </div>

        <div class="input-row">
            <div class="input-group" style="flex:2;">
                <label>Exercice</label>
                <input type="text" id="exoName" placeholder="ex: Bench Press">
            </div>
            <div class="input-group">
                <label>kg</label>
                <input type="number" id="exoWeight" placeholder="0">
            </div>
            <div class="input-group">
                <label>Reps</label>
                <input type="number" id="exoReps" placeholder="0">
            </div>
        </div>

        <button class="btn-add-set" onclick="ajouterExercice()">+ AJOUTER LE SET</button>

        <ul id="currentSessionList" class="current-exercise-list">
            </ul>

        <div style="margin-top: 40px;">
            <button id="btnSave" class="btn-primary btn-danger">TERMINER LA SÉANCE</button>
            <button class="btn-cancel" onclick="cancelWorkout()">Annuler</button>
        </div>
    </div>

    <script type="module">
        // 1. IMPORTS
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. CONFIG (NE PAS TOUCHER)
        const firebaseConfig = {
          apiKey: "AIzaSyBuzNrrB-rK_xcjSeGtFc3I9yUKHhRUcIY",
          authDomain: "b-strong-4c3d1.firebaseapp.com",
          projectId: "b-strong-4c3d1",
          storageBucket: "b-strong-4c3d1.firebasestorage.app",
          messagingSenderId: "746501272062",
          appId: "1:746501272062:web:b2181766fd23ce8a3f10af"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- VARIABLES GLOBALES ---
        let sessionEnCours = [];
        let timerInterval;
        let seconds = 0;

        // --- NAVIGATION ---
        window.switchView = function(viewName) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            if (viewName === 'workout') {
                document.getElementById('viewWorkout').classList.add('active');
                document.querySelector('header').style.display = 'none'; // Masquer header pendant workout
                startTimer();
            } else {
                document.getElementById('viewHistory').classList.add('active');
                document.querySelector('header').style.display = 'flex';
            }
        }

        window.cancelWorkout = function() {
            if(confirm("Annuler la séance en cours ?")) {
                sessionEnCours = [];
                document.getElementById('currentSessionList').innerHTML = '';
                stopTimer();
                switchView('history');
            }
        }

        // --- TIMER ---
        function startTimer() {
            seconds = 0;
            document.getElementById('timer').innerText = "00:00";
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); }

        // --- LOGIQUE D'AJOUT ---
        window.ajouterExercice = function() {
            const nom = document.getElementById('exoName').value;
            const reps = document.getElementById('exoReps').value;
            const poids = document.getElementById('exoWeight').value;

            if(nom && reps) {
                // Data
                sessionEnCours.push({ nom, reps, poids });

                // UI (Style Strong)
                const li = document.createElement('li');
                li.className = 'current-exercise-item';
                li.innerHTML = `
                    <div>
                        <div class="exo-info">${nom}</div>
                        <div class="exo-details">${poids} kg x ${reps} reps</div>
                    </div>
                    <div style="color:var(--accent-green);">✔</div>
                `;
                document.getElementById('currentSessionList').appendChild(li);

                // Reset champs (Garder le nom pour enchainer les séries comme sur Strong)
                // document.getElementById('exoName').value = ''; 
                document.getElementById('exoReps').value = '';
                // On garde le poids aussi souvent
            } else {
                alert("Nom et Reps obligatoires");
            }
        }

        // --- SAUVEGARDE FIREBASE ---
        document.getElementById('btnSave').addEventListener('click', async () => {
            if (sessionEnCours.length === 0) return;

            const btn = document.getElementById('btnSave');
            btn.innerText = "Enregistrement...";
            
            try {
                await addDoc(collection(db, "workouts"), {
                    date: serverTimestamp(),
                    exercises: sessionEnCours,
                    duration: seconds // On sauvegarde la durée
                });

                // Succès
                stopTimer();
                sessionEnCours = [];
                document.getElementById('currentSessionList').innerHTML = '';
                btn.innerText = "TERMINER LA SÉANCE";
                
                chargerHistorique(); // Mise à jour liste
                switchView('history'); // Retour accueil

            } catch (e) {
                console.error(e);
                alert("Erreur sauvegarde");
                btn.innerText = "TERMINER LA SÉANCE";
            }
        });

        // --- LECTURE HISTORIQUE (CARD DESIGN) ---
        async function chargerHistorique() {
            const container = document.getElementById('historyList');
            const q = query(collection(db, "workouts"), orderBy("date", "desc"));
            const snapshot = await getDocs(q);

            container.innerHTML = "";
            
            if(snapshot.empty) {
                container.innerHTML = '<div class="empty-state">Aucune séance récente</div>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const dateObj = data.date ? data.date.toDate() : new Date();
                const dateStr = dateObj.toLocaleDateString("fr-FR", { weekday:'long', day:'numeric', month:'long' });
                
                // Calcul du volume total (Poids x Reps) pour faire "Pro"
                let totalVolume = 0;
                let setsCount = 0;
                let exercisesSummary = "";

                if(data.exercises) {
                    data.exercises.forEach(ex => {
                        totalVolume += (parseFloat(ex.poids) || 0) * (parseFloat(ex.reps) || 0);
                        setsCount++;
                    });
                    // On prend juste les 3 premiers exos pour le résumé
                    exercisesSummary = data.exercises.slice(0, 3).map(e => e.nom).join(", ");
                    if(data.exercises.length > 3) exercisesSummary += "...";
                }

                // Création de la carte HTML
                const card = document.createElement('div');
                card.className = 'history-card';
                card.innerHTML = `
                    <div class="history-header">
                        <div>
                            <div class="history-title">Workout</div>
                            <div class="history-date">${dateStr}</div>
                        </div>
                        <div style="text-align:right; font-size:12px; color:var(--text-secondary);">
                            <div>${Math.round(totalVolume)} kg</div>
                            <div>${setsCount} sets</div>
                        </div>
                    </div>
                    <div class="set-preview">
                        <span>${exercisesSummary}</span>
                        <span style="color:var(--accent-blue);">Voir ></span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Lancement
        chargerHistorique();

    </script>
</body>
</html>

