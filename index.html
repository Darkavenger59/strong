<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B-STRONG DEBUG</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* BOITE D'ERREUR (Pour comprendre le probl√®me) */
        #debug-log {
            background: #ff0000; color: white; padding: 15px;
            font-size: 14px; font-family: monospace;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 10000;
            display: none; border-bottom: 2px solid white;
        }

        /* DESIGN */
        :root { --bg: #000000; --card: #1C1C1E; --text: #FFFFFF; --blue: #0A84FF; --red: #FF453A; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding-bottom: 80px; user-select: none; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        h1 { text-align: center; margin: 20px 0; font-size: 20px; }
        
        /* VUES */
        .view { display: none; padding: 20px; }
        .view.active { display: block; }

        /* BOUTONS */
        .btn-big {
            display: block; margin: 0 auto;
            width: 180px; height: 180px; border-radius: 50%;
            background: var(--blue); color: white; border: none;
            font-size: 24px; font-weight: bold; cursor: pointer;
        }
        .btn-big:active { opacity: 0.8; transform: scale(0.95); }

        .btn-action { width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 10px; border: none; font-weight: bold; font-size: 16px; }
        .blue { background: #333; color: var(--blue); border: 1px solid var(--blue); }
        .red { background: var(--red); color: white; }
        
        /* INPUTS */
        input { background: #222; border: none; color: white; padding: 10px; width: 100%; margin-bottom: 10px; border-radius: 5px; }
        
        /* LISTE */
        .card { background: var(--card); padding: 15px; margin-bottom: 10px; border-radius: 10px; }
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #111; display: flex; border-top: 1px solid #333; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; font-size: 10px; }
        .nav-item.active { color: var(--blue); }
        .nav-icon { font-size: 20px; margin-bottom: 3px; }

        /* MODAL */
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:5000; justify-content:center; align-items:center; }
        .box { background: #222; width:95%; padding:20px; border-radius:15px; position: relative; }
        .close { position: absolute; top:10px; right:15px; font-size:30px; }
    </style>
</head>
<body>

    <div id="debug-log"></div>

    <h1>B-STRONG</h1>

    <div id="v-home" class="view active">
        <div style="height:60vh; display:flex; align-items:center; justify-content:center;">
            <button class="btn-big" onclick="startWorkout()">GO</button>
        </div>
        <div style="text-align:center;">
            <button onclick="addDemoData()" style="background:none; border:none; color:#666;">+ Ajouter d√©mo</button>
        </div>
    </div>

    <div id="v-history" class="view">
        <div id="hist-list">Chargement...</div>
    </div>

    <div id="v-charts" class="view">
        <p>Cliquez pour voir la progression :</p>
        <div id="chart-list"></div>
    </div>

    <div id="v-workout" class="view">
        <h2>En cours... <span id="timer" style="color:#888; font-size:16px;">00:00</span></h2>
        <input type="text" id="w-name" placeholder="Nom (ex: Squat)" list="dl">
        <datalist id="dl"></datalist>
        <div style="display:flex; gap:10px;">
            <input type="number" id="w-kg" placeholder="Kg">
            <input type="number" id="w-reps" placeholder="Reps">
        </div>
        <button class="btn-action blue" onclick="addSet()">+ Ajouter S√©rie</button>
        <ul id="w-list" style="list-style:none; padding:0; color:#ccc;"></ul>
        <div style="margin-top:30px;">
            <button class="btn-action red" onclick="saveWorkout()">Terminer</button>
            <button class="btn-action" onclick="cancelWorkout()" style="background:none; color:#888;">Annuler</button>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="showTab('home', this)">
            <span class="nav-icon">üè†</span>Accueil
        </div>
        <div class="nav-item" onclick="showTab('history', this)">
            <span class="nav-icon">üìÖ</span>Historique
        </div>
        <div class="nav-item" onclick="showTab('charts', this)">
            <span class="nav-icon">üìà</span>Graphiques
        </div>
    </div>

    <div id="modal">
        <div class="box">
            <span class="close" onclick="document.getElementById('modal').style.display='none'">&times;</span>
            <h3 id="m-title" style="color:var(--blue); margin-top:0;">Titre</h3>
            <p id="m-sub" style="color:#888; font-size:12px;">...</p>
            <div style="height:300px;"><canvas id="myChart"></canvas></div>
        </div>
    </div>

    <script>
        // --- 1. SYSTEME DE LOG D'ERREUR ---
        function logError(msg) {
            var box = document.getElementById('debug-log');
            box.style.display = 'block';
            box.innerText += "‚ö†Ô∏è " + msg + "\n";
            console.error(msg);
        }
        window.onerror = function(message) { logError(message); };

        // --- 2. VARIABLES ---
        var currentSession = [];
        var allData = [];
        var stats = {};
        var known = new Set();
        var db = null;
        var timerInt = null;
        var seconds = 0;
        var myChart = null;

        // --- 3. INIT FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyBuzNrrB-rK_xcjSeGtFc3I9yUKHhRUcIY",
          authDomain: "b-strong-4c3d1.firebaseapp.com",
          projectId: "b-strong-4c3d1",
          storageBucket: "b-strong-4c3d1.firebasestorage.app",
          messagingSenderId: "746501272062",
          appId: "1:746501272062:web:b2181766fd23ce8a3f10af"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            // Test de connexion
            // alert("App Pr√™te ! Firebase OK."); 
            loadData();
        } catch(e) {
            logError("Erreur Init Firebase: " + e.message);
        }

        // --- 4. FONCTIONS ---
        
        // Navigation simple
        window.showTab = function(name, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('v-'+name).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(el) el.classList.add('active');

            if(name === 'history') renderHistory();
            if(name === 'charts') renderCharts();
        };

        // Workout
        window.startWorkout = function() {
            showTab('workout');
            seconds = 0; document.getElementById('timer').innerText = "00:00";
            clearInterval(timerInt);
            timerInt = setInterval(function(){
                seconds++;
                var m = Math.floor(seconds/60).toString().padStart(2,'0');
                var s = (seconds%60).toString().padStart(2,'0');
                document.getElementById('timer').innerText = m+":"+s;
            }, 1000);
            updateDatalist();
        };

        window.cancelWorkout = function() {
            if(confirm("Annuler ?")) {
                currentSession=[];
                document.getElementById('w-list').innerHTML='';
                clearInterval(timerInt);
                showTab('home');
            }
        };

        window.addSet = function() {
            var n = document.getElementById('w-name').value.trim();
            var k = document.getElementById('w-kg').value;
            var r = document.getElementById('w-reps').value;
            if(!n || !r) return alert("Manque infos");
            
            n = n.charAt(0).toUpperCase() + n.slice(1);
            currentSession.push({nom:n, poids:k, reps:r});
            
            var li = document.createElement('li');
            li.innerHTML = "<b>"+n+"</b> : "+k+"kg x "+r;
            document.getElementById('w-list').appendChild(li);
            document.getElementById('w-reps').value = '';
        };

        window.saveWorkout = function() {
            if(currentSession.length===0) return;
            var btn = document.querySelector('.red');
            btn.innerText = "Envoi...";

            db.collection("workouts").add({
                date: firebase.firestore.FieldValue.serverTimestamp(),
                exercises: currentSession,
                duration: seconds
            }).then(function() {
                btn.innerText = "Terminer";
                currentSession=[];
                document.getElementById('w-list').innerHTML='';
                document.getElementById('w-name').value='';
                clearInterval(timerInt);
                loadData(); // Recharge
                showTab('history');
            }).catch(function(error) {
                logError(error.message);
                btn.innerText = "Erreur";
            });
        };

        window.addDemoData = function() {
            if(!confirm("Ajouter d√©mo ?")) return;
            var d = new Date(); d.setDate(d.getDate()-7); // Semaine derni√®re
            db.collection("workouts").add({
                date: firebase.firestore.Timestamp.fromDate(d),
                duration: 3000,
                exercises: [{nom:"Squat", poids:80, reps:10}, {nom:"Squat", poids:80, reps:10}]
            }).then(function(){
                alert("Fait"); loadData();
            });
        };

        // --- 5. DATA ---
        function loadData() {
            db.collection("workouts").orderBy("date", "desc").get().then(function(snap) {
                allData = [];
                stats = {};
                known.clear();

                snap.forEach(function(doc) {
                    var d = doc.data();
                    var dateObj = d.date ? d.date.toDate() : new Date();
                    allData.push({data:d, date:dateObj});

                    if(d.exercises) {
                        // Calcul pour stats
                        var sessionVol = {};
                        d.exercises.forEach(function(ex) {
                            var key = ex.nom.trim().toLowerCase();
                            var display = ex.nom.charAt(0).toUpperCase() + ex.nom.slice(1);
                            known.add(display);

                            var vol = (parseFloat(ex.poids)||0)*(parseFloat(ex.reps)||0);
                            if(!sessionVol[key]) sessionVol[key]=0;
                            sessionVol[key]+=vol;
                        });

                        for(var k in sessionVol) {
                            if(!stats[k]) stats[k]=[];
                            stats[k].push({date: dateObj, vol: sessionVol[k]});
                        }
                    }
                });
            }).catch(function(err){
                logError(err.message);
            });
        }

        function updateDatalist() {
            var dl = document.getElementById('dl');
            dl.innerHTML="";
            known.forEach(function(k){
                var opt = document.createElement('option');
                opt.value=k; dl.appendChild(opt);
            });
        }

        // --- 6. RENDU ---
        function renderHistory() {
            var div = document.getElementById('hist-list');
            div.innerHTML = "";
            allData.forEach(function(item) {
                var dStr = item.date.toLocaleDateString('fr-FR', {day:'numeric', month:'short'});
                var card = document.createElement('div');
                card.className = 'card';
                
                var html = "<b>"+dStr+"</b> ("+Math.floor((item.data.duration||0)/60)+" min)<br>";
                if(item.data.exercises) {
                    item.data.exercises.forEach(function(e){
                        html += e.nom + ": " + e.poids + "x" + e.reps + " | ";
                    });
                }
                card.innerHTML = html;
                div.appendChild(card);
            });
        }

        function renderCharts() {
            var div = document.getElementById('chart-list');
            div.innerHTML = "";
            for(var k in stats) {
                var btn = document.createElement('div');
                btn.className = 'card';
                btn.innerText = k.toUpperCase();
                (function(key){
                    btn.onclick = function() { openChart(key); };
                })(k);
                div.appendChild(btn);
            }
        }

        // --- 7. GRAPHIQUE SEMAINE ---
        function getMonday(d) {
            d = new Date(d);
            var day = d.getDay(),
                diff = d.getDate() - day + (day == 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        window.openChart = function(key) {
            document.getElementById('modal').style.display='flex';
            document.getElementById('m-title').innerText = key.toUpperCase();

            var raw = stats[key] || [];
            // Tri chronologique
            raw.sort(function(a,b){ return a.date - b.date; });

            // Agregation Semaine
            var weeks = {};
            raw.forEach(function(r){
                var mon = getMonday(r.date);
                var kWeek = mon.toISOString().split('T')[0]; // YYYY-MM-DD
                var label = mon.toLocaleDateString('fr-FR', {day:'numeric', month:'short'});
                
                if(!weeks[kWeek]) weeks[kWeek] = {label:label, vol:0, date:mon};
                weeks[kWeek].vol += r.vol;
            });

            // Convertir en array tri√©
            var finalData = [];
            for(var w in weeks) finalData.push(weeks[w]);
            finalData.sort(function(a,b){ return a.date - b.date; });

            // Total vie
            var total = 0; raw.forEach(function(x){ total+=x.vol; });
            document.getElementById('m-sub').innerText = "Total Vie: " + (total/1000).toFixed(1) + " T";

            // Chart
            var ctx = document.getElementById('myChart').getContext('2d');
            if(myChart) myChart.destroy();
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: finalData.map(function(x){return x.label}),
                    datasets: [{
                        label: 'Volume (kg)',
                        data: finalData.map(function(x){return x.vol}),
                        borderColor: '#0A84FF', borderWidth: 3, fill: false, tension: 0.1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        };

    </script>
  <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            // Le point . est important pour dire "dans ce dossier actuel"
            navigator.serviceWorker.register('./service-worker.js')
                .then(reg => console.log('SW enregistr√©:', reg))
                .catch(err => console.log('Erreur SW:', err));
        });
    }
  </script>
    
    
</body>
</html>
