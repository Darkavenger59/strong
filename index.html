<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B-Strong Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- STYLE DARK MODE "STRONG" --- */
        :root {
            --bg-app: #000000;
            --bg-card: #1C1C1E;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --accent-blue: #0A84FF;
            --accent-red: #FF453A;
            --separator: #2C2C2E;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-app); color: var(--text-primary);
            font-family: var(--font); margin: 0; padding: 0; padding-bottom: 80px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* HEADER */
        header {
            padding: 15px 20px; background-color: var(--bg-card);
            border-bottom: 1px solid var(--separator); position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        h1 { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: 0.5px; }

        /* VIEWS */
        .view { display: none; padding: 15px; }
        .view.active { display: block; }

        /* --- HISTORIQUE AMÉLIORÉ --- */
        .history-card {
            background-color: var(--bg-card); border-radius: 12px;
            padding: 16px; margin-bottom: 16px;
        }
        .history-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--separator); padding-bottom: 12px; margin-bottom: 12px;
        }
        .history-date { font-weight: 600; font-size: 16px; }
        .history-meta { color: var(--text-secondary); font-size: 13px; }

        /* Groupe d'exercice */
        .exercise-group { margin-bottom: 12px; }
        .exercise-group:last-child { margin-bottom: 0; }
        
        .exercise-name {
            color: var(--accent-blue); font-weight: 600; font-size: 15px;
            margin-bottom: 4px; cursor: pointer; display: inline-block;
        }
        .exercise-name:hover { text-decoration: underline; }
        
        .set-list {
            font-size: 14px; color: var(--text-secondary);
            line-height: 1.4;
        }
        .set-tag {
            display: inline-block; background: #2C2C2E; color: #fff;
            padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-right: 4px;
        }

        /* --- WORKOUT INPUTS --- */
        .input-row {
            display: flex; gap: 10px; background: var(--bg-card);
            padding: 15px; border-radius: 12px; margin-bottom: 15px;
        }
        .input-wrapper { flex: 1; }
        label { display: block; color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin-bottom: 4px; }
        input {
            width: 100%; background: transparent; border: none;
            border-bottom: 1px solid var(--separator); color: white;
            font-size: 18px; padding: 4px 0; border-radius: 0;
        }
        input:focus { outline: none; border-bottom-color: var(--accent-blue); }

        .btn-add {
            width: 100%; padding: 14px; background: #2C2C2E; color: var(--accent-blue);
            border: 1px solid var(--accent-blue); border-radius: 10px; font-weight: 600;
            cursor: pointer; margin-bottom: 20px;
        }

        /* Liste session en cours */
        .current-list { list-style: none; padding: 0; }
        .current-item {
            background: var(--bg-card); padding: 12px; border-radius: 8px;
            margin-bottom: 8px; display: flex; justify-content: space-between;
            border-left: 3px solid var(--accent-blue);
        }

        /* FAB & ACTION BUTTONS */
        .fab-container {
            position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 90;
            display: flex; flex-direction: column; gap: 10px;
        }
        .btn-main {
            background: var(--accent-blue); color: white; border: none;
            padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 700;
            width: 100%; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer;
        }
        .btn-danger { background-color: var(--accent-red); }

        /* MODAL CHART */
        #chartModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            flex-direction: column; padding: 20px;
        }
        .chart-box {
            background: var(--bg-card); width: 100%; max-width: 600px;
            padding: 15px; border-radius: 16px; margin: auto; position: relative;
        }
        .close-chart {
            position: absolute; top: 10px; right: 15px; font-size: 24px; color: #888; cursor: pointer;
        }
    </style>
</head>
<body>

    <header id="appHeader">
        <h1>B-STRONG</h1>
        <div style="font-size:12px; color:#666;">PRO</div>
    </header>

    <div id="viewHistory" class="view active">
        <div id="historyContainer">Chargement...</div>
        <div class="fab-container">
            <button class="btn-main" onclick="switchView('workout')">Démarrer une séance</button>
        </div>
    </div>

    <div id="viewWorkout" class="view">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 style="margin:0;">Séance en cours</h2>
            <span id="timer" style="font-variant-numeric: tabular-nums; color:#888;">00:00</span>
        </div>

        <div class="input-row">
            <div class="input-wrapper" style="flex: 2;">
                <label>Exercice</label>
                <input type="text" id="exoName" list="suggestions" placeholder="Ex: Squat" autocomplete="off">
                <datalist id="suggestions"></datalist>
            </div>
            <div class="input-wrapper">
                <label>kg</label>
                <input type="number" id="exoWeight" placeholder="0">
            </div>
            <div class="input-wrapper">
                <label>Reps</label>
                <input type="number" id="exoReps" placeholder="0">
            </div>
        </div>

        <button class="btn-add" onclick="addSet()">+ AJOUTER SÉRIE</button>

        <ul id="currentList" class="current-list"></ul>

        <div style="margin-top: 40px;">
            <button id="btnSave" class="btn-main btn-danger">TERMINER</button>
            <button style="background:none; border:none; color:#888; width:100%; padding:15px;" onclick="cancelWorkout()">Annuler</button>
        </div>
    </div>

    <div id="chartModal">
        <div class="chart-box">
            <span class="close-chart" onclick="document.getElementById('chartModal').style.display='none'">&times;</span>
            <h3 id="chartTitle" style="color:var(--accent-blue); margin-top:0;">Progression</h3>
            <canvas id="myChart"></canvas>
            <p style="font-size:12px; color:#666; text-align:center; margin-top:10px;">
                Graphique basé sur le poids MAX soulevé par séance.
            </p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBuzNrrB-rK_xcjSeGtFc3I9yUKHhRUcIY",
          authDomain: "b-strong-4c3d1.firebaseapp.com",
          projectId: "b-strong-4c3d1",
          storageBucket: "b-strong-4c3d1.firebasestorage.app",
          messagingSenderId: "746501272062",
          appId: "1:746501272062:web:b2181766fd23ce8a3f10af"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // STATE
        let currentSession = [];
        let globalHistory = [];
        let knownExercises = new Set();
        let timerInt;
        let seconds = 0;
        let chartInstance = null;

        // NAVIGATION
        window.switchView = (v) => {
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            if(v === 'workout') {
                document.getElementById('viewWorkout').classList.add('active');
                document.getElementById('appHeader').style.display = 'none';
                startTimer();
                updateSuggestions();
            } else {
                document.getElementById('viewHistory').classList.add('active');
                document.getElementById('appHeader').style.display = 'flex';
            }
        };

        window.cancelWorkout = () => {
            if(confirm("Tout effacer ?")) {
                currentSession = [];
                document.getElementById('currentList').innerHTML = '';
                stopTimer();
                switchView('history');
            }
        };

        // TIMER
        function startTimer() {
            seconds = 0; document.getElementById('timer').textContent = "00:00";
            clearInterval(timerInt);
            timerInt = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds/60).toString().padStart(2,'0');
                const s = (seconds%60).toString().padStart(2,'0');
                document.getElementById('timer').textContent = `${m}:${s}`;
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInt); }

        // WORKOUT LOGIC
        function updateSuggestions() {
            const dl = document.getElementById('suggestions');
            dl.innerHTML = '';
            knownExercises.forEach(ex => {
                let opt = document.createElement('option');
                opt.value = ex;
                dl.appendChild(opt);
            });
        }

        window.addSet = () => {
            let nom = document.getElementById('exoName').value.trim();
            const reps = document.getElementById('exoReps').value;
            const poids = document.getElementById('exoWeight').value;

            if(!nom || !reps) return alert("Nom et Reps requis");
            
            // Normalisation du nom (Majuscule au début)
            nom = nom.charAt(0).toUpperCase() + nom.slice(1);

            currentSession.push({ nom, reps, poids });

            // Ajout visuel
            const ul = document.getElementById('currentList');
            const li = document.createElement('li');
            li.className = 'current-item';
            li.innerHTML = `
                <div><strong>${nom}</strong> <span style="color:#888">${poids}kg x ${reps}</span></div>
                <div style="color:var(--accent-green)">✔</div>
            `;
            ul.appendChild(li);

            // On vide seulement les reps, on garde le nom et le poids pour enchaîner
            document.getElementById('exoReps').value = '';
        };

        document.getElementById('btnSave').addEventListener('click', async () => {
            if(currentSession.length === 0) return;
            const btn = document.getElementById('btnSave');
            btn.textContent = "Sauvegarde...";
            
            try {
                await addDoc(collection(db, "workouts"), {
                    date: serverTimestamp(),
                    exercises: currentSession,
                    duration: seconds
                });
                
                stopTimer();
                currentSession = [];
                document.getElementById('currentList').innerHTML = '';
                document.getElementById('exoName').value = ''; // Reset nom
                btn.textContent = "TERMINER";
                loadHistory();
                switchView('history');
            } catch(e) {
                alert("Erreur : " + e.message);
                btn.textContent = "TERMINER";
            }
        });

        // --- HISTORIQUE & REGROUPEMENT (La partie importante) ---
        async function loadHistory() {
            const container = document.getElementById('historyContainer');
            const q = query(collection(db, "workouts"), orderBy("date", "desc"));
            const snap = await getDocs(q);
            
            globalHistory = [];
            knownExercises.clear();
            container.innerHTML = "";

            if(snap.empty) {
                container.innerHTML = "<div style='text-align:center; margin-top:50px; color:#666'>Aucune séance</div>";
                return;
            }

            snap.forEach(doc => {
                const data = doc.data();
                const date = data.date ? data.date.toDate() : new Date();
                globalHistory.push({ date, exercises: data.exercises || [] });

                // Créer la carte
                const card = document.createElement('div');
                card.className = 'history-card';
                
                // Header de la carte
                const dateStr = date.toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long'});
                const timeStr = Math.floor((data.duration || 0)/60) + " min";
                
                let html = `
                    <div class="history-header">
                        <div class="history-date">${dateStr}</div>
                        <div class="history-meta">⏱ ${timeStr}</div>
                    </div>
                `;

                // --- LOGIQUE DE REGROUPEMENT ---
                // On transforme la liste plate [Squat, Squat, Bench, Bench] 
                // en objet { "Squat": [set1, set2], "Bench": [set1, set2] }
                const grouped = {};
                if(data.exercises) {
                    data.exercises.forEach(ex => {
                        const n = ex.nom;
                        knownExercises.add(n); // Pour l'autocomplete
                        if(!grouped[n]) grouped[n] = [];
                        grouped[n].push(ex);
                    });
                }

                // On affiche chaque groupe
                for (const [nom, sets] of Object.entries(grouped)) {
                    // Création du résumé des sets (ex: "100x10, 100x10")
                    const setSummary = sets.map(s => `${s.poids}kg×${s.reps}`).join(', ');
                    const nbSets = sets.length;

                    html += `
                        <div class="exercise-group">
                            <div class="exercise-name" onclick="window.showChart('${nom}')">${nom} ></div>
                            <div class="set-list">
                                <span class="set-tag">${nbSets} sets</span> ${setSummary}
                            </div>
                        </div>
                    `;
                }

                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        // --- GRAPHIQUE (Chart.js) ---
        window.showChart = (exoName) => {
            document.getElementById('chartModal').style.display = 'flex';
            document.getElementById('chartTitle').textContent = exoName;

            const labels = [];
            const dataPoints = [];

            // On parcourt l'historique du plus vieux au plus récent
            [...globalHistory].reverse().forEach(session => {
                // Trouver tous les sets de cet exercice dans cette séance
                const sets = session.exercises.filter(e => e.nom === exoName);
                
                if(sets.length > 0) {
                    // Trouver le POIDS MAX soulevé lors de cette séance
                    const maxWeight = Math.max(...sets.map(s => parseFloat(s.poids) || 0));
                    
                    labels.push(session.date.toLocaleDateString('fr-FR', {day:'numeric', month:'short'}));
                    dataPoints.push(maxWeight);
                }
            });

            const ctx = document.getElementById('myChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Poids Max (kg)',
                        data: dataPoints,
                        borderColor: '#0A84FF',
                        backgroundColor: 'rgba(10, 132, 255, 0.1)',
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: {display:false} },
                    scales: {
                        y: { grid: {color:'#333'}, ticks: {color:'#888'} },
                        x: { grid: {display:false}, ticks: {color:'#888'} }
                    }
                }
            });
        };

        // Init
        loadHistory();

    </script>
</body>
</html>
